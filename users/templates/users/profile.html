{% extends 'core/base.html' %}
{% load time_formats %}
{% load static %}
{% load crispy_forms_tags %}
{% load background_images %}

{% block content %}
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <section class="card stacked">
            <h2>Update Profile</h2>

            <span class="spaced flex-row align-center">
                <img class="profile-pic" src="{{ user.profile.image.url }}" alt="profile picture">

                <label for="{{ profile_form.image.id_for_label }}" class="custom-file-upload">
                    <i class="fas fa-cloud-upload-alt"></i>
                    Upload Image
                    {{ profile_form.image }}
                </label>
                {{ profile_form.image.errors }}
                <script>
                    // Add the selected file name to the label so that the user can preview it
                    $('#id_image').on('change',function(){
                        //get the file name
                        let fileName = $(this).val().split('\\').pop();

                        // change the image preview
                        if (this.files && this.files[0]) {
                            let reader = new FileReader();

                            reader.onload = function (e) {
                                $('.profile-pic').attr('src', e.target.result);
                            }
                            reader.readAsDataURL(this.files[0]);
                        }

                        //replace the "Choose a file" label
                        $(this).next('.custom-file-upload').html('<i class="fas fa-cloud-upload-alt"></i> '
                            + fileName
                            + '{{ profile_form.image }}'
                        );
                    })

                </script>
            </span>

            <span class="label-input">
                {{ user_form.username.errors }}
                {{ user_form.username.label_tag }}
                {{ user_form.username }}
            </span>

            <span class="label-input">
                {{ user_form.email.errors }}
                {{ user_form.email.label_tag }}
                {{ user_form.email }}
            </span>

            <label>
                {{ profile_form.automatic_background.label_tag }}
                <label class="switch">
                    {{ profile_form.automatic_background }}
                    <span class="slider round"></span>
                </label>
                {{ profile_form.automatic_background.errors }}
            </label>

            <div id="automatic_background_options" style="display: none;">
                <h4>Background Source:</h4>
                {% for radio in profile_form.background_choice %}
                    <div class="radio-option">
                        {{ radio.tag }}
                        <label for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                    </div>
                {% endfor %}
                {{ profile_form.background_choice.errors }}
            </div>

            <span class="label-input uploaded_backgrounds">
                <label for="{{ profile_form.background_image.id_for_label }}">
                    <i class="fas fa-cloud-upload-alt"></i> Upload Background Image
                </label>
                {{ profile_form.background_image }}
            </span>

            <span class="uploaded_backgrounds">
                 {% if user.profile.background_image %}
                    <p>Current background:</p>

                    <br>

                    <img src="{{ user.profile.background_image.url }}" alt="Current background" style="max-width: 100px; max-height: 100px;">

                    <br>

                    <label>
                        {{ profile_form.remove_background_image.label_tag }}
                        <label class="switch">
                            {{ profile_form.remove_background_image }}
                            <span class="slider round"></span>
                        </label>
                        {{ profile_form.remove_background_image.errors }}
                    </label>

                    <!-- Download manually uploaded background image -->
                    <p>
                        <button type="button" class="secondary-button" title="Download current background image" aria-label="Download current background image" onclick="window.location.href='{% url 'download_background' %}'">
                            <i class="fas fa-download"></i> Download Background
                        </button>
                    </p>
                 {% endif %}
            </span>


            <script>
                $(document).ready(function() {
                    // Check initial state
                    if ($('#id_automatic_background').is(':checked')) {
                        $('#automatic_background_options').show();
                        $('.uploaded_backgrounds').hide();
                        $('.background-context').show();
                    }

                    // Toggle visibility when automatic background checkbox changes
                    $('#id_automatic_background').change(function() {
                        if ($(this).is(':checked')) {
                            $('#automatic_background_options').show();
                            $('.uploaded_backgrounds').hide();
                            $('.background-context').show();
                        } else {
                            $('#automatic_background_options').hide();
                            $('.uploaded_backgrounds').show();
                            $('.background-context').hide();
                        }
                    });
                });
            </script>

            <span>
                <button type="submit" id="update-profile" class="primary-button">
                    <i class="fa fa-check-circle"></i>
                    Update Profile
                </button>
            </span>
        </section>
    </form>

    <!-- Background image context card -->
    {% if user.profile.automatic_background %}
        <section class="card stacked background-context">
            <h2>About Background</h2>
            {% if user.profile.bing_background %}
                {% bing_background as bing_url %}
                <h3>{% bing_background_title %}</h3>
                <p>{% bing_background_description %}</p>
                {% if bing_url %}
                    <p>
                        <button type="button" class="secondary-button" title="Download Bing daily image" aria-label="Download Bing daily image" onclick="window.location.href='{% url 'download_background' %}'">
                            <i class="fas fa-download"></i> Download Background
                        </button>
                    </p>
                {% endif %}
            {% elif user.profile.nasa_apod_background %}
                {% nasa_apod_background as nasa_url %}
                <h3>{% nasa_apod_title %}</h3>
                <p>{% nasa_apod_explanation %}</p>
                {% if nasa_url %}
                    <p>
                        <button type="button" class="secondary-button" title="Download NASA APOD image" aria-label="Download NASA APOD image" onclick="window.location.href='{% url 'download_background' %}'">
                            <i class="fas fa-download"></i> Download Background
                        </button>
                    </p>
                {% endif %}
            {% else %}
                <p>No automatic background source selected.</p>
            {% endif %}
        </section>
    {% else %}
        <section class="card stacked background-context" style="display:none;"></section>
    {% endif %}
{% endblock %}
