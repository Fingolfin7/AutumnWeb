{% extends 'core/base.html' %}
{% load static %}
{% load time_formats %}
{% load markdown_render %}
{% load param_replace %}

{% block head_includes %}
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script> <!-- for jquery ui and autocomplete-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"> </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js" type="text/javascript"></script>
    <script src="{% static 'core/js/search_projects.js' %}?v={{ static_version.search_projects }}" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'core/css/chat_style.css' %}?v={{ static_version.chat_style }}">
    <script type="text/javascript">
        const PROVIDER_MODELS = {{ provider_models_json|safe }};
        function repopulateModels(provider, selectedModel){
            const modelSelect = $('#model');
            modelSelect.empty();
            const entries = PROVIDER_MODELS[provider] || [];
            entries.forEach(entry => {
                const opt = $('<option></option>').val(entry.value).text(entry.label);
                if (entry.value === selectedModel) opt.attr('selected','selected');
                modelSelect.append(opt);
            });
            if (!selectedModel && entries.length>0){
                modelSelect.val(entries[0].value);
            }
        }

        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fa fa-check"></i>';
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                }, 2000);
            });
        }

        function copyFullChat() {
            const messages = [];
            $('.conversation-container > div').each(function() {
                let sender = 'User';
                if ($(this).hasClass('user-message')) {
                    sender = '{{ username|default:"User" }}';
                } else if ($(this).hasClass('assistant-message')) {
                    const model = $(this).data('model') || '{{ selected_model|default:"LLM" }}';
                    sender = `Autumn (${model})`;
                }
                const content = $(this).find('.message-content').text().trim();
                if (content) {
                    messages.push(`[${sender}]\n${content}`);
                }
            });
            const fullText = messages.join('\n\n---\n\n');
            navigator.clipboard.writeText(fullText).then(() => {
                const btn = $('#copy-full-chat-btn');
                const originalText = btn.html();
                btn.html('<i class="fa fa-check"></i> Copied!');
                setTimeout(() => btn.html(originalText), 2000);
            });
        }

        function toggleSidebar() {
            const sidebar = $('.chat-sidebar');
            sidebar.toggleClass('collapsed');
            const isCollapsed = sidebar.hasClass('collapsed');
            localStorage.setItem('chatSidebarCollapsed', isCollapsed);
            
            // Update icon
            const icon = $('#toggle-sidebar-btn i');
            if (isCollapsed) {
                icon.removeClass('fa-chevron-left').addClass('fa-chevron-right');
            } else {
                icon.removeClass('fa-chevron-right').addClass('fa-chevron-left');
            }
        }

        $(document).ready(function(){
            // Restore sidebar state
            if (localStorage.getItem('chatSidebarCollapsed') === 'true') {
                toggleSidebar();
            }

            // Set the default start date to the start of the current month
            let current_date = new Date();
            // Only set default dates if they aren't already set (from a previous search)
            if (!$('#start_date').val()) {
                $('#start_date').val(new Date(current_date.getFullYear(), current_date.getMonth(), 1).toISOString().split('T')[0]);
            }
            if (!$('#end_date').val()) {
                $('#end_date').val(new Date().toISOString().split('T')[0]);
            }

            // initial populate
            repopulateModels('{{ selected_provider }}','{{ selected_model }}');
            // keep GET filter hidden fields in sync
            $('#provider_filter').val($('#provider').val());
            $('#model_filter').val($('#model').val() || '{{ selected_model }}');

            $('#provider').on('change', function(){
                const newProvider = $(this).val();
                repopulateModels(newProvider,null);
                $('#provider_filter').val(newProvider);
                $('#model_filter').val($('#model').val());
            });
            
            $('#model').on('change', function() {
                let selected = $(this).val();
                $('#model_filter').val(selected);
            });

            // Scroll conversation to bottom
            const container = document.getElementById('conversation-container');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        });
    </script>
{% endblock %}

{% block content %}
    <section id="search_options">
        <form method="get" id="search_form" class="card flex-row" enctype="multipart/form-data">
            <div id="search_projects">
                <span class="label-input">
                    <label for="project-search"><i class="fa fa-search"></i> Search</label>
                    {{ search_form.project_name }}
                    {{ search_form.project_name.errors }}
                </span>
                <span id="project-search-results"></span>
            </div>

            <span class="label-input" id="filter_start">
                <label for="start_date"><i class="fa fa-calendar"></i> Start Date</label>
                {{ search_form.start_date }}
                {{ search_form.start_date.errors }}
            </span>

            <span class="label-input" id="filter_end">
                <label for="end_date"><i class="fa fa-calendar"></i> End Date</label>
                {{ search_form.end_date }}
                {{ search_form.end_date.errors }}
            </span>

            <span class="label-input">
                <label for="context-filter"><i class="fa fa-layer-group"></i> Context</label>
                {{ search_form.context }}
                {{ search_form.context.errors }}
            </span>

            <span class="label-input">
                <label for="tag-filter"><i class="fa fa-tags"></i> Tags</label>
                <details class="tag-dropdown">
                    <summary class="tag-summary">Select tags</summary>
                    <div class="tag-options">
                        {% for cb in search_form.tags %}
                            <label class="tag-option">
                                {{ cb }} <span class="tag-label">{{ cb.choice_label }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </details>
                {{ search_form.tags.errors }}
            </span>

            <span class="label-input">
                <label for="note_snippet"><i class="fa fa-sticky-note"></i> Note</label>
                {{ search_form.note_snippet }}
                {{ search_form.note_snippet.errors }}
            </span>

            <input type="hidden" name="provider" id="provider_filter" value="{{ selected_provider }}">
            <input type="hidden" name="model" id="model_filter" value="{{ selected_model }}">

            <span>
                <button type="submit" class="primary-button" id="search_button" name="filter" value="true">
                    <i class="fa fa-filter"></i>
                    Filter Sessions
                </button>
            </span>
        </form>
    </section>

    <div class="chat-layout card">
        <aside class="chat-sidebar">
            <a href="{% url 'insights' %}" class="primary-button new-chat-btn">
                <i class="fa fa-plus"></i> New Chat
            </a>
            <div class="chat-list">
                {% for chat in recent_chats %}
                    <div class="chat-item-container {% if chat.id == chat_id %}active{% endif %}">
                        <a href="{% url 'insights_detail' chat.id %}" class="chat-item {% if chat.id == chat_id %}active{% endif %}">
                            <span class="chat-title" title="{{ chat.title }}">{{ chat.title }}</span>
                        </a>
                        <a href="{% url 'delete_chat' chat.id %}" class="delete-chat-btn" onclick="return confirm('Delete this chat?')">
                            <i class="fa fa-trash"></i>
                        </a>
                    </div>
                {% empty %}
                    <p class="text-muted text-center">No recent chats.</p>
                {% endfor %}
            </div>
        </aside>

        <main class="chat-main">
            <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                <button type="button" id="toggle-sidebar-btn" onclick="toggleSidebar()" title="Toggle Sidebar">
                    <i class="fa fa-chevron-left"></i>
                </button>
            </div>
            {% if not sessions and not conversation_history %}
                <div class="empty-state-container">
                    <img src="{% static 'core/images/reddit_such_empty_transparent.png' %}" alt="No sessions found">
                    <p class="text-muted">Filter some sessions to start a conversation!</p>
                </div>
            {% else %}
                <div class="chat-header">
                    <div>
                        <h3>{% if session_count > 0 %}Selected Sessions: {{ session_count }}{% else %}Conversation History{% endif %}
                            <small style="font-weight:normal; font-size:0.7em; margin-left:0.5rem;" title="Approximate token usage for this conversation">
                                Tokens: {{ usage_stats.prompt|default:0 }}/{{ usage_stats.response|default:0 }}
                            </small>
                        </h3>
                        {% if session_count > 0 %}
                        <p class="text-muted">Date Range:
                            <span class="text-cyan">{{ earliest_date|day_date_formatter }}</span> to
                            <span class="text-cyan">{{ latest_date|day_date_formatter }}</span>
                        </p>
                        {% endif %}
                    </div>
                    {% if conversation_history %}
                    <button type="button" id="copy-full-chat-btn" class="copy-full-chat-btn" onclick="copyFullChat()">
                        <i class="fa fa-copy"></i> Copy Full Chat
                    </button>
                    {% endif %}
                </div>

                <form method="post" class="chat-form" style="display: flex; flex-direction: column; flex: 1;">
                    {% csrf_token %}

                    <div class="button-group" style="margin-bottom: 15px;">
                        <span class="label-input">
                            <label for="provider">Provider</label>
                            <select id="provider" name="provider">
                                {% for p in providers %}
                                    <option value="{{ p }}" {% if p == selected_provider %}selected{% endif %}>{{ p|capfirst }}</option>
                                {% endfor %}
                            </select>
                        </span>

                        <span class="label-input">
                            <label for="model">Model</label>
                            <select id="model" name="model"></select>
                        </span>
                    </div>

                    <div id="conversation-container" class="conversation-container">
                        {% if conversation_history %}
                            {% for message in conversation_history %}
                                {% if message.role == 'user' %}
                                    <div class="user-message">
                                        <div class="message-content">
                                            {{ message.content|markdown|safe|linebreaks }}
                                        </div>
                                    </div>
                                {% elif message.role == 'assistant' %}
                                    <div class="assistant-message" data-model="{{ message.model|default:selected_model }}">
                                        <button type="button" class="copy-btn" title="Copy message" 
                                                onclick="copyToClipboard(`{{ message.content|escapejs }}`, this)">
                                            <i class="fa fa-copy"></i>
                                        </button>
                                        <div class="message-content">
                                            {{ message.content|markdown|safe|linebreaks }}
                                        </div>
                                        {% if message.sources|length > 0 %}
                                            <br><hr><br>
                                            <small class="assistant-sources">
                                                <strong>Sources:</strong>
                                                {% for source in message.sources %}
                                                    <a href="{{source.link}}" class="plain-link" target="_blank" rel="noopener noreferrer">
                                                        {{source.title|default:forloop.counter|cut:" "}}
                                                        {% if not forloop.last %},{% endif %}
                                                    </a>
                                                {% endfor %}
                                            </small>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <div class="empty-state-container" style="opacity: 0.5;">
                                <i class="fa fa-comments fa-3x"></i>
                                <p>Start a new conversation about the selected sessions.</p>
                            </div>
                        {% endif %}
                    </div>

                    <span class="label-input full-width">
                        <textarea name="prompt" id="prompt" rows="2" class="full-width"
                                  placeholder="Ask a question about your sessions..."></textarea>
                    </span>

                    <div class="button-group">
                        <button type="submit" class="primary-button">
                            <i class="fa fa-paper-plane"></i> Send
                        </button>
                    </div>
                </form>
            {% endif %}
        </main>
    </div>
{% endblock %}
